<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Pianoforte Interattivo</title>
  <script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>
  <style>
    body {
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 20px;
    }

    .controls {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
    margin-bottom: 20px;
    font-size: 14px;
    }

    .controls button {
    min-width: 160px;       /* üîÅ dimensione minima uguale */
    padding: 10px 16px;     /* üîÅ padding uniforme */
    font-size: 16px;
    background-color: #4caf50;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    display: inline-flex;     /* üîÅ per allineare icona + testo */
    align-items: center;
    justify-content: center;
    gap: 8px;                 /* üîÅ spazio tra icona e testo */
    transition: background 0.2s ease;
    }

    .controls button:hover {
    background-color: #45a049;
    }


    .row {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 10px;
    }

    .row-note select {
    width: 60px;
    }

    select, input[type="range"] {
    padding: 4px;
    font-size: 14px;
    }

    button {
    padding: 6px 12px;
    font-size: 14px;
    background-color: #4caf50;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.2s;
    }

    button:hover {
    background-color: #45a049;
    }

    .label-inline {
    margin-left: 10px;
    }


    #scaleSpeedLabel {
    margin-top: 8px;
    display: inline-block;
    font-weight: bold;
    }


    #startAudio, #playChord {
      padding: 10px 20px;
      font-size: 16px;
    }

    .piano {
      display: flex;
      position: relative;
      height: 200px;
    }

    .key-wrapper {
      position: relative;
    }

    .white-key {
      width: 40px;
      height: 200px;
      background: white;
      border: 1px solid #000;
      z-index: 1;
      position: relative;
      display: flex;
      justify-content: center;
      align-items: flex-end;
      font-size: 12px;
      cursor: pointer;
      user-select: none;
    }

    .black-key {
      width: 24px;
      height: 120px;
      background: black;
      color: white;
      position: absolute;
      top: 0;
      left: 28px;
      z-index: 2;
      display: flex;
      justify-content: center;
      align-items: flex-end;
      font-size: 10px;
      cursor: pointer;
      user-select: none;
    }

    .white-key.active {
        background: #ffcc00;
        color: black;
        box-shadow: 0 0 8px #ffcc00;
    }

    .black-key.active {
        background: #ffcc00;
        color: black;
        box-shadow: 0 0 8px #ffcc00;
    }

    #chordNotes {
      margin-top: 10px;
      font-size: 18px;
    }

    #chordNotes span {
        padding: 3px 6px;
        border-radius: 4px;
        margin: 2px;
        font-weight: bold;
        display: inline-block;
        transition: background 0.2s ease;
    }

    #chordNotes span.highlight {
        background-color: #ffeb3b;
        color: #000;
    }


  </style>
</head>
<body>

<div class="controls">

  <!-- Riga 1: Nota -->
  <div class="row row-note">
    <label for="rootNote">Nota:</label>
    <select id="rootNote">
      <option>C</option><option>Db</option><option>D</option><option>Eb</option>
      <option>E</option><option>F</option><option>Gb</option><option>G</option>
      <option>Ab</option><option>A</option><option>Bb</option><option>B</option>
    </select>
  </div>

  <!-- Riga 2: Accordo -->
  <div class="row row-chord">
    <label for="chordType">Accordo:</label>
    <select id="chordType">
      <option value="maj">Maggiore</option>
      <option value="min">Minore</option>
      <option value="aug">Aumentato</option>
      <option value="dim">Diminuito</option>
      <option value="7">Dominante 7</option>
      <option value="maj7">Maggiore 7</option>
      <option value="min7">Minore 7</option>
      <option value="6">Sesta</option>
      <option value="min6">Minore 6</option>
      <option value="5">Power chord (5)</option>
      <option value="sus2">Sospeso 2</option>
      <option value="sus4">Sospeso 4</option>
    </select>
    <button id="playChord">üéµ Suona Accordo</button>
  </div>

  <!-- Riga 3: Scala + Velocit√† + Pulsante -->
  <div class="row row-scale">
    <label for="scaleType">Scala:</label>
    <select id="scaleType">
      <option value="major">Maggiore</option>
      <option value="minor">Minore</option>
      <option value="harmonic">Minore Armonica</option>
      <option value="melodic">Minore Melodica</option>
      <option value="pentatonic">Pentatonica</option>
      <option value="blues">Blues</option>
    </select>

    <label for="scaleSpeed" class="label-inline">Velocit√†:</label>
    <input type="range" id="scaleSpeed" min="1" max="10" value="5" step="1">
    <span id="scaleSpeedLabel">600 ms</span>

    <button id="playScale">üé∂ Suona Scala</button>
  </div>

</div>



<div class="piano" id="piano"></div>
<div id="chordNotes"></div>

<script>
    const keyCodeToNote = {
        "CapsLock":"G3","KeyQ": "Ab3", "KeyA": "A3", "KeyW": "Bb3", "KeyS": "B3", "KeyD": "C4",
        "KeyR": "Db4", "KeyF": "D4", "KeyT": "Eb4", "KeyG": "E4", "KeyH": "F4",
        "KeyU": "Gb4", "KeyJ": "G4", "KeyI": "Ab4", "KeyK": "A4", "KeyO": "Bb4",
        "KeyL": "B4", "Semicolon": "C5", "BracketLeft": "Db5", "Quote": "D5",
        "BracketRight": "Eb5", "Backslash": "E5"
    };

    const noteToKeyLabel = {};
    for (const [code, note] of Object.entries(keyCodeToNote)) {
        let key = code.replace("Key", "")
            .replace("Semicolon", "√≤")
            .replace("Quote", "√†")
            .replace("BracketLeft", "√®")
            .replace("BracketRight", "+")
            .replace("Backslash", "√π")
            .replace("CapsLock", "‚á™"); // opzionale
        noteToKeyLabel[note] = key;
    }
    const pianoContainer = document.getElementById("piano");

    const samplerUrls = {};
    Object.values(keyCodeToNote).forEach(note => {
        samplerUrls[note] = `${note}.mp3`;
    });

    const sampler = new Tone.Sampler({
        urls: samplerUrls,
        release: 0.3,
        baseUrl: "piano-mp3/"
    }).toDestination();

    let audioStarted = false;

    let scaleTimeouts = [];

    async function ensureAudioStarted() {
        if (!audioStarted) {
            await Tone.start();
            audioStarted = true;
            console.log("Audio attivato.");
        }
    }

    // document.getElementById("startAudio").addEventListener("click", async () => {
    //     await Tone.start();
    //     audioStarted = true;
    //     document.getElementById("startAudio").style.display = "none";
    // });

    async function playNote(note, duration = 300, show = false) {
        await ensureAudioStarted();

        sampler.triggerAttackRelease(note, duration / 1000);

        const el = document.querySelector(`[data-note='${note}']`);
        if (el) {
            el.classList.add("active");
            setTimeout(() => el.classList.remove("active"), duration);
        }

        const noteSpan = document.querySelector(`#chordNotes span[data-display-note='${note}']`);
        if (noteSpan) {
            noteSpan.classList.add("highlight");
            setTimeout(() => noteSpan.classList.remove("highlight"), duration);
        }

        // üéØ Quando √® una singola nota suonata manualmente (show === true)
        if (show) {
            const display = document.getElementById("chordNotes");
            display.innerHTML = "Nota: " + `<span data-display-note="${note}">${note}</span>`;
        }

    }


    const semitoneMap = {
        "C": 0, "Db": 1, "D": 2, "Eb": 3, "E": 4,
        "F": 5, "Gb": 6, "G": 7, "Ab": 8, "A": 9,
        "Bb": 10, "B": 11
    };


    // Ricava note da keyCodeToNote
    const allNotes = Array.from(new Set(Object.values(keyCodeToNote))).sort((a, b) => {
        const n = note => parseInt(note.slice(-1)) * 12 + semitoneMap[note.replace(/[0-9]/g, "")];
        return n(a) - n(b);
    });

    // Mappa dei diesis (neri)
    const blackNoteMap = {
        "C": "Db", "D": "Eb", "F": "Gb", "G": "Ab", "A": "Bb"
    };

    function getWhiteNotesOnly(notes) {
        return notes.filter(n => !n.includes("b"));
    }

    function buildKeyboard() {
        const octaves = {};

        allNotes.forEach(note => {
        const pitch = note.slice(0, -1);
        const octave = note.slice(-1);
        if (!octaves[octave]) octaves[octave] = [];
        octaves[octave].push(note);
        });

        Object.keys(octaves).sort().forEach(octave => {
        const whiteNotes = ["C", "D", "E", "F", "G", "A", "B"];
        whiteNotes.forEach(note => {
            const fullNote = note + octave;
            if (!allNotes.includes(fullNote)) return;

            const wrapper = document.createElement("div");
            wrapper.className = "key-wrapper";

            const whiteKey = document.createElement("div");
            whiteKey.className = "white-key";
            //whiteKey.textContent = fullNote;
            whiteKey.textContent = noteToKeyLabel[fullNote] || fullNote;  // ‚úÖ mostra tasto
            whiteKey.dataset.note = fullNote;
            whiteKey.addEventListener("mousedown", () => {
                scaleTimeouts.forEach(t => clearTimeout(t));
                scaleTimeouts = [];
                playNote(fullNote, 300, true);
            });
            wrapper.appendChild(whiteKey);

            const blackName = blackNoteMap[note];
            const blackNote = blackName ? blackName + octave : null;
            if (blackNote && allNotes.includes(blackNote)) {
            const blackKey = document.createElement("div");
            blackKey.className = "black-key";
            //blackKey.textContent = blackNote;
            blackKey.textContent = noteToKeyLabel[blackNote] || blackNote;  // ‚úÖ
            blackKey.dataset.note = blackNote;
            blackKey.addEventListener("mousedown", () => {
                scaleTimeouts.forEach(t => clearTimeout(t));
                scaleTimeouts = [];
                playNote(blackNote, 300, true);
            });
            wrapper.appendChild(blackKey);
            }

            pianoContainer.appendChild(wrapper);
        });
        });
    }

    buildKeyboard();

    // === Accordi ===
    const chordIntervals = {
        "maj": [0, 4, 7],
        "min": [0, 3, 7],
        "aug": [0, 4, 8],
        "dim": [0, 3, 6],
        "7": [0, 4, 7, 10],
        "maj7": [0, 4, 7, 11],
        "min7": [0, 3, 7, 10],
        "6": [0, 4, 7, 9],
        "min6": [0, 3, 7, 9],
        "5": [0, 7],
        "sus2": [0, 2, 7],
        "sus4": [0, 5, 7]
    };

    const scaleFormulas = {
        major:      [0, 2, 4, 5, 7, 9, 11],
        minor:      [0, 2, 3, 5, 7, 8, 10],
        harmonic:   [0, 2, 3, 5, 7, 8, 11],
        melodic:    [0, 2, 3, 5, 7, 9, 11],
        pentatonic: [0, 2, 4, 7, 9],
        blues:      [0, 3, 5, 6, 7, 10]
    };

    function noteToMidi(note) {
        const name = note.replace(/[0-9]/g, "");
        const octave = parseInt(note.slice(-1));
        return 12 * (octave + 1) + semitoneMap[name];
    }

    function midiToNote(midi) {
        const notes = ["C", "Db", "D", "Eb", "E", "F", "Gb", "G", "Ab", "A", "Bb", "B"];
        const name = notes[midi % 12];
        const octave = Math.floor(midi / 12) - 1;
        return name + octave;
    }

    document.getElementById("playChord").addEventListener("click", async () => {
        await ensureAudioStarted();

        scaleTimeouts.forEach(t => clearTimeout(t));
        scaleTimeouts = [];

        const root = document.getElementById("rootNote").value;
        const type = document.getElementById("chordType").value;
        const rootMidi = noteToMidi(root + "4");
        const chord = chordIntervals[type].map(i => midiToNote(rootMidi + i));

        chord.forEach(note => playNote(note, 1000)); // Durata 1000ms

        const display = document.getElementById("chordNotes");
        display.innerHTML = "Accordo: " + chord.map(n => `<span data-display-note="${n}">${n}</span>`).join(" ");

    });


    document.getElementById("scaleSpeed").addEventListener("input", (e) => {
        const value = parseInt(e.target.value);
        const label = document.getElementById("scaleSpeedLabel");
        if (label) label.textContent = `Velocit√†: ${value} ms`;
    });

    

    document.getElementById("playScale").addEventListener("click", async () => {
        await ensureAudioStarted();

        // üßπ Interrompe eventuali scale precedenti
        scaleTimeouts.forEach(t => clearTimeout(t));
        scaleTimeouts = [];

        const root = document.getElementById("rootNote").value;
        const type = document.getElementById("scaleType").value;
        const rootMidi = noteToMidi(root + "4");
        const intervals = scaleFormulas[type];
        const scaleNotes = intervals.map(i => midiToNote(rootMidi + i));

        // Inverti lo slider: pi√π alto ‚Üí pi√π veloce
        const speedValue = parseInt(document.getElementById("scaleSpeed").value);
        const delay = 1100 - (speedValue * 100); // es: 1 ‚Üí 1000ms, 10 ‚Üí 100ms

        // Aggiorna etichetta
        document.getElementById("scaleSpeedLabel").textContent = `Velocit√†: ${delay} ms`;

        // Mostra subito la lista completa
        const display = document.getElementById("chordNotes");
        display.innerHTML = "Scala: " + scaleNotes.map(n => `<span data-display-note="${n}">${n}</span>`).join(" ");

        // üéµ Suona e colora una per una (e salva i timeout)
        scaleNotes.forEach((note, index) => {
            const t = setTimeout(() => {
            playNote(note, delay);
            }, index * delay);
            scaleTimeouts.push(t); // ‚úÖ salva timeout per eventuale cancellazione
        });
    });







    // Keyboard support
    const activeKeys = new Set();
    document.addEventListener("keydown", e => {
        //console.log(e.code);
        if (!audioStarted) return;
        const note = keyCodeToNote[e.code];
        if (note && !activeKeys.has(note)) {

            scaleTimeouts.forEach(t => clearTimeout(t));
            scaleTimeouts = [];
            
            activeKeys.add(note);
            playNote(note, 300, true);
        }
    });

    document.addEventListener("keyup", e => {
        const note = keyCodeToNote[e.code];
        if (note) activeKeys.delete(note);
    });
</script>

</body>
</html>
